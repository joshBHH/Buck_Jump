<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Whitetail Runner</title>
<style>
  :root { --bg:#0b1b24; --ground:#25404d; --ui:#e6f2f7; --accent:#76d7ea; --hit:#ff6978; --orange:#ff7f11; }
  html,body { height:100%; margin:0; background:var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; }
  .wrap { display:grid; place-items:center; height:100%; }
  .stage { position:relative; display:flex; gap:10px; align-items:flex-start; }
  canvas {
    width: min(95vw, 1000px); aspect-ratio: 9 / 4;
    background: linear-gradient(#102833, #0b1b24 60%) no-repeat;
    border-radius:16px; box-shadow: 0 8px 30px rgba(0,0,0,.35);
    touch-action: none; /* remove mobile delay / gestures */
  }
  .hud {
    position: absolute; inset: 0; display:flex; align-items:flex-start; justify-content:space-between;
    padding: 10px 14px; pointer-events:none; color:var(--ui); font-weight:600; text-shadow:0 2px 6px rgba(0,0,0,.6);
    font-size: clamp(14px, 2vw, 18px);
  }
  .centerMsg {
    position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
    color:var(--ui); text-align:center; padding: 0 16px; text-shadow:0 4px 16px rgba(0,0,0,.6);
  }
  .btnRow {
    position:absolute; inset:auto 0 10px 0; display:flex; justify-content:center; gap:12px; pointer-events:auto; flex-wrap:wrap;
  }
  .btn {
    background: rgba(255,255,255,.08); backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.15); color:var(--ui);
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    user-select:none;
  }
  .btn:active { transform: translateY(1px); }

  /* Always-visible scoreboard panel */
  .sidePanel {
    color:var(--ui);
    background: rgba(10,20,26,.85);
    border:1px solid rgba(255,255,255,.15);
    border-radius:16px;
    padding:12px;
    width: 240px;
    box-shadow: 0 8px 30px rgba(0,0,0,.5);
    font-size: 14px;
  }
  .sidePanel h3 { margin: 0 0 8px 0; font-size: 16px; }
  .field { display:flex; gap:6px; align-items:center; margin-bottom:8px; }
  .field input[type="text"]{
    flex:1; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2);
    color: var(--ui); padding:6px 8px; border-radius:10px; font-weight:700; text-transform:uppercase;
  }
  .scoresList { max-height: 260px; overflow:auto; border-top:1px solid rgba(255,255,255,.15); margin-top:6px; padding-top:6px; }
  .row { display:flex; justify-content:space-between; gap:8px; margin:.2rem 0; }
  .muted { opacity:.8; }
  .mini { font-size:12px; opacity:.8; }
  .panelBtns { display:flex; gap:8px; margin-top:8px; }

  @media (max-width: 980px){
    .stage { flex-direction:column; align-items:center; }
    .sidePanel { width: min(92vw, 340px); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <div style="position:relative">
      <canvas id="game" width="900" height="400" aria-label="Whitetail Runner"></canvas>

      <div class="hud">
        <div id="score">Score: 0</div>
        <div id="hiscore">Best: 0</div>
      </div>

      <div class="centerMsg" id="centerMsg">
        <div class="panel" id="panelContent" style="background: rgba(10,20,26,.85); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:16px; max-width:min(92vw, 520px); box-shadow: 0 8px 30px rgba(0,0,0,.5);">
          <h1 style="margin:0 0 12px 0; font-size:clamp(22px,4vw,36px);">Whitetail Runner</h1>
          <p class="muted" style="margin:.25rem 0">Press <b>Space</b>/<b>↑</b> or <b>Tap anywhere</b> to jump</p>
          <p class="muted" style="margin:.25rem 0">Avoid the hunter’s <b>arrows</b> and <b>bullets</b>. Speed ramps up!</p>
          <div class="btnRow">
            <button class="btn" id="startBtn">Start</button>
            <button class="btn" id="pauseBtn">Pause</button>
            <button class="btn" id="restartBtn">Restart</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Always-visible scoreboard panel -->
    <div class="sidePanel" id="sidePanel">
      <h3>High Scores</h3>
      <div class="field">
        <label for="nameInput" class="mini">Name</label>
        <input id="nameInput" type="text" maxlength="8" value="YOU" />
      </div>
      <div class="mini muted">Best Personal: <b id="bestLabel">0</b></div>
      <div class="scoresList" id="scoresList"></div>
      <div class="panelBtns">
        <button class="btn" id="clearBtn" style="padding:6px 10px;">Clear Board</button>
        <button class="btn" id="demoAddBtn" style="padding:6px 10px;">Add Test</button>
      </div>
      <div class="mini muted" style="margin-top:6px">Scores save automatically on Game Over.</div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // UI refs
  const scoreEl = document.getElementById('score');
  const hiscoreEl = document.getElementById('hiscore');
  const centerMsg = document.getElementById('centerMsg');
  const panelContent = document.getElementById('panelContent');

  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn');

  // Scoreboard panel refs
  const nameInput = document.getElementById('nameInput');
  const bestLabel = document.getElementById('bestLabel');
  const scoresList = document.getElementById('scoresList');
  const clearBtn = document.getElementById('clearBtn');
  const demoAddBtn = document.getElementById('demoAddBtn');
  const sidePanel = document.getElementById('sidePanel');

  // Storage keys
  const HS_KEY = 'whitetail_hiscore_v3';
  const SCORES_KEY = 'whitetail_scoreboard_v3';
  const NAME_KEY = 'whitetail_player_name_v3';

  // Load persistent data
  let hiScore = Number(localStorage.getItem(HS_KEY) || 0);
  let savedName = (localStorage.getItem(NAME_KEY) || 'YOU').toUpperCase().slice(0,8);
  nameInput.value = savedName;
  hiscoreEl.textContent = 'Best: ' + hiScore;
  bestLabel.textContent = hiScore;

  function loadScores(){
    try { return JSON.parse(localStorage.getItem(SCORES_KEY) || '[]'); }
    catch { return []; }
  }
  function saveScores(arr){ localStorage.setItem(SCORES_KEY, JSON.stringify(arr)); }
  function addScore(name, score){
    const scores = loadScores();
    scores.push({ name: (name||'YOU').slice(0,8).toUpperCase(), score, date: Date.now() });
    scores.sort((a,b) => b.score - a.score);
    saveScores(scores.slice(0, 10));
    renderScores();
  }
  function renderScores(){
    const scores = loadScores();
    scoresList.innerHTML = scores.length
      ? scores.map((s,i)=>`<div class="row"><div>#${i+1}. <b>${s.name}</b></div><div>${s.score}</div></div>`).join('')
      : `<div class="mini muted">No scores yet — be the first!</div>`;
  }
  renderScores();

  nameInput.addEventListener('input', () => {
    const v = (nameInput.value || 'YOU').toUpperCase().slice(0,8);
    nameInput.value = v;
    localStorage.setItem(NAME_KEY, v);
  });
  clearBtn.addEventListener('click', () => { localStorage.removeItem(SCORES_KEY); renderScores(); });
  demoAddBtn.addEventListener('click', () => { addScore(nameInput.value || 'YOU', Math.floor(Math.random()*1000)); });

  // Game state
  const W = canvas.width, H = canvas.height;
  const groundY = H - 64;
  let running = false, paused = false, gameOver = false;
  let tPrev = 0, score = 0, speed = 300, spawnTimer = 0;

  // Weapon swap rates (seconds)
  const SWAP_MIN = 4, SWAP_MAX = 7;
  let nextSwapIn = rand(SWAP_MIN, SWAP_MAX);

  // Deer (longer legs & bigger rack)
  const deer = { x: 90, y: groundY - 48, w: 60, h: 48, vy: 0, onGround: true };

  // Hunter (right side, blaze orange)
  const hunter = { x: W - 120, y: groundY - 60, w: 50, h: 60, weapon: 'bow', fireTimer: 0 };

  const obstacles = []; // projectiles
  const dust = [];      // landing dust particles

  // ======= Input: ultra-responsive tap anywhere on canvas =======
  // Jump buffering & coyote time for responsiveness
  const JUMP_BUFFER = 0.12;   // seconds allowed to buffer a jump before landing
  const COYOTE_TIME = 0.10;   // seconds allowed to jump after leaving ground
  let jumpBufferTimer = 0;
  let coyoteTimer = 0;

  function requestJump(){
    jumpBufferTimer = JUMP_BUFFER; // set a short window to convert to actual jump
  }
  function tryPerformJump(){
    if ((deer.onGround || coyoteTimer > 0) && jumpBufferTimer > 0){
      deer.vy = -560; // slightly snappier
      deer.onGround = false;
      jumpBufferTimer = 0;
      coyoteTimer = 0;
    }
  }

  // Keyboard
  window.addEventListener('keydown', e => {
    if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); requestJump(); }
    if (e.code === 'KeyP') togglePause();
    if (e.code === 'Enter') { if (!running || gameOver) startGame(true); }
  }, {passive:false});

  // Pointer: tap anywhere on canvas to jump
  // Avoid stealing taps on the sidePanel (name/clear buttons)
  function isInside(el, target){
    while (target){ if (target === el) return tru
